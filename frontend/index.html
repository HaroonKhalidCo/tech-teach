<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tech-Teach</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: system-ui, sans-serif; background: #0f172a; color: #e2e8f0; min-height: 100vh; padding: 2rem; }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { text-align: center; margin-bottom: 2rem; color: #60a5fa; }
        
        .grid { display: grid; grid-template-columns: 350px 1fr; gap: 2rem; }
        @media (max-width: 900px) { .grid { grid-template-columns: 1fr; } }
        
        .card { background: #1e293b; border-radius: 12px; padding: 1.5rem; }
        .card h2 { margin-bottom: 1rem; font-size: 1.1rem; }
        
        label { display: block; margin-bottom: 0.5rem; font-size: 0.85rem; color: #94a3b8; }
        select, textarea { width: 100%; padding: 0.75rem; background: #0f172a; border: 1px solid #334155; border-radius: 8px; color: #e2e8f0; font-size: 1rem; margin-bottom: 1rem; }
        textarea { min-height: 100px; resize: vertical; }
        
        .tools { display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap; }
        .tool { padding: 0.75rem 1rem; background: #0f172a; border: 2px solid #334155; border-radius: 8px; cursor: pointer; text-align: center; flex: 1; min-width: 55px; }
        .tool:hover { border-color: #60a5fa; }
        .tool.active { border-color: #60a5fa; background: rgba(96,165,250,0.2); }
        .tool-icon { font-size: 1.3rem; display: block; }
        .tool-label { font-size: 0.65rem; }
        
        .btn { width: 100%; padding: 1rem; background: linear-gradient(135deg, #3b82f6, #8b5cf6); border: none; border-radius: 8px; color: white; font-size: 1rem; font-weight: 600; cursor: pointer; }
        .btn:hover { opacity: 0.9; }
        .btn:disabled { opacity: 0.5; cursor: wait; }
        
        #result { display: none; }
        #result.show { display: block; }
        
        .loading { text-align: center; padding: 3rem; }
        .spinner { width: 40px; height: 40px; border: 4px solid #334155; border-top-color: #60a5fa; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1rem; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .video-box { background: #000; border-radius: 8px; overflow: hidden; margin-bottom: 1rem; }
        .video-box video { width: 100%; display: block; }
        
        .info { background: #0f172a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; }
        .info p { margin: 0.25rem 0; font-size: 0.9rem; }
        
        .download-btn { display: inline-block; padding: 0.75rem 1.5rem; background: #10b981; border-radius: 8px; color: white; text-decoration: none; font-weight: 600; margin-right: 0.5rem; margin-bottom: 0.5rem; }
        .download-btn:hover { background: #059669; }
        
        .success-msg { background: rgba(16,185,129,0.2); border: 1px solid #10b981; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; color: #10b981; }
        .error-msg { background: rgba(239,68,68,0.2); border: 1px solid #ef4444; padding: 1rem; border-radius: 8px; color: #ef4444; }
        
        .slides { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; }
        .slide { border-radius: 8px; overflow: hidden; border: 2px solid #334155; cursor: pointer; }
        .slide:hover { border-color: #60a5fa; }
        .slide img { width: 100%; display: block; }
        
        .cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; }
        .flashcard { background: #0f172a; border: 2px solid #3b82f6; border-radius: 8px; padding: 1rem; cursor: pointer; min-height: 120px; }
        .flashcard.flipped { background: #3b82f6; }
        .flashcard .q { font-weight: 600; margin-bottom: 0.5rem; color: #60a5fa; }
        .flashcard.flipped .q { color: rgba(255,255,255,0.7); }
        .flashcard.flipped .answer { display: block; }
        .flashcard .answer { display: none; }
        
        .pdf-frame { width: 100%; height: 600px; border: none; border-radius: 8px; background: white; }
        
        /* Mind Map Styles */
        .mind-map-container { background: #0f172a; border-radius: 8px; padding: 1.5rem; max-height: 600px; overflow: auto; }
        .mind-map-info { margin-bottom: 1rem; padding: 0.75rem; background: rgba(96,165,250,0.1); border-radius: 8px; }
        .mind-map-info span { margin-right: 1.5rem; font-size: 0.85rem; }
        
        .mm-node { margin: 0.25rem 0; }
        .mm-node-header { display: flex; align-items: flex-start; gap: 0.5rem; padding: 0.5rem 0.75rem; border-radius: 6px; cursor: pointer; transition: background 0.2s; }
        .mm-node-header:hover { background: rgba(255,255,255,0.05); }
        .mm-toggle { width: 18px; height: 18px; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; color: #64748b; flex-shrink: 0; }
        .mm-label { font-weight: 600; }
        .mm-desc { font-size: 0.85rem; color: #94a3b8; margin-top: 0.2rem; }
        .mm-children { margin-left: 1.25rem; padding-left: 0.75rem; border-left: 2px solid #334155; display: none; }
        .mm-node.expanded > .mm-children { display: block; }
        
        /* Level colors */
        .mm-node[data-level="0"] > .mm-node-header .mm-label { color: #3b82f6; font-size: 1.1rem; }
        .mm-node[data-level="1"] > .mm-node-header .mm-label { color: #8b5cf6; }
        .mm-node[data-level="2"] > .mm-node-header .mm-label { color: #ec4899; }
        .mm-node[data-level="3"] > .mm-node-header .mm-label { color: #f59e0b; }
        .mm-node[data-level="4"] > .mm-node-header .mm-label { color: #10b981; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéì Tech-Teach</h1>
        
        <div class="grid">
            <div class="card">
                <h2>Generate Content</h2>
                
                <label>Task</label>
                <select id="task">
                    <option value="lesson_plan">Lesson Plan</option>
                </select>
                
                <label>Output Type</label>
                <div class="tools">
                    <div class="tool" data-tool="pdf"><span class="tool-icon">üìÑ</span><span class="tool-label">PDF</span></div>
                    <div class="tool" data-tool="presentation"><span class="tool-icon">üñºÔ∏è</span><span class="tool-label">Slides</span></div>
                    <div class="tool" data-tool="mind_map"><span class="tool-icon">üß†</span><span class="tool-label">Map</span></div>
                    <div class="tool active" data-tool="ppt_video" id="videoTool"><span class="tool-icon">üé¨</span><span class="tool-label">Video</span></div>
                    <div class="tool" data-tool="flashcards"><span class="tool-icon">üìá</span><span class="tool-label">Cards</span></div>
                </div>
                
                <label>Instructions</label>
                <textarea id="instructions">Create educational content about the solar system</textarea>
                
                <button class="btn" id="genBtn" onclick="generate()">‚ú® Generate</button>
            </div>
            
            <div class="card" id="result">
                <h2>Result</h2>
                <div id="output"></div>
            </div>
        </div>
    </div>

    <script>
        const API = 'http://localhost:8000';
        let tool = 'ppt_video';
        
        // Tool selection
        document.querySelectorAll('.tool').forEach(el => {
            el.onclick = function(e) {
                e.preventDefault();
                document.querySelectorAll('.tool').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                tool = this.dataset.tool;
            };
        });
        
        async function generate() {
            const btn = document.getElementById('genBtn');
            const instructions = document.getElementById('instructions').value;
            const task = document.getElementById('task').value;
            
            if (!instructions.trim()) {
                alert('Enter instructions');
                return;
            }
            
            btn.disabled = true;
            btn.textContent = '‚è≥ Generating...';
            
            // Show result area with loading
            const resultDiv = document.getElementById('result');
            resultDiv.classList.add('show');
            
            try {
                // For video, use background task with polling
                if (tool === 'ppt_video') {
                    await generateVideoWithPolling(instructions);
                } else {
                    // Other tools use direct API call
                    document.getElementById('output').innerHTML = '<div class="loading"><div class="spinner"></div><p>Generating ' + tool + '...</p><p style="color:#64748b;font-size:0.9rem;">This may take a moment</p></div>';
                    
                    const res = await fetch(API + '/api/v1/generate/', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            task_name: task,
                            tool_name: tool,
                            instructions: instructions,
                            pdf_data: null,
                            additional_params: {}
                        })
                    });
                    
                    const data = await res.json();
                    console.log('Response:', data);
                    
                    if (data.status === 'success') {
                        showResult(data);
                    } else {
                        document.getElementById('output').innerHTML = '<div class="error-msg">Error: ' + (data.message || 'Failed') + '</div>';
                    }
                }
            } catch (err) {
                console.error(err);
                document.getElementById('output').innerHTML = '<div class="error-msg">Connection error. Is the server running?</div>';
            }
            
            btn.disabled = false;
            btn.textContent = '‚ú® Generate';
        }
        
        async function generateVideoWithPolling(instructions) {
            // Start video generation
            document.getElementById('output').innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p id="videoStatus">Starting video generation...</p>
                    <div style="margin-top:1rem;background:#334155;border-radius:8px;height:8px;overflow:hidden;">
                        <div id="progressBar" style="width:0%;height:100%;background:linear-gradient(90deg,#3b82f6,#8b5cf6);transition:width 0.3s;"></div>
                    </div>
                    <p id="videoStage" style="color:#64748b;font-size:0.85rem;margin-top:0.5rem;">Initializing...</p>
                </div>
            `;
            
            try {
                // Start the video task
                const startRes = await fetch(API + '/api/v1/generate/video/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ instructions: instructions })
                });
                
                const startData = await startRes.json();
                const taskId = startData.task_id;
                console.log('Video task started:', taskId);
                
                // Poll for status
                let complete = false;
                while (!complete) {
                    await new Promise(r => setTimeout(r, 2000)); // Poll every 2 seconds
                    
                    const statusRes = await fetch(API + '/api/v1/generate/video/status/' + taskId);
                    const status = await statusRes.json();
                    console.log('Status:', status);
                    
                    // Update UI
                    document.getElementById('progressBar').style.width = status.progress + '%';
                    document.getElementById('videoStatus').textContent = status.progress + '% Complete';
                    document.getElementById('videoStage').textContent = status.message || status.stage;
                    
                    if (status.status === 'complete') {
                        complete = true;
                        // Show the video
                        showResult({
                            status: 'success',
                            tool_name: 'ppt_video',
                            file_url: status.file_url,
                            data: status.result
                        });
                    } else if (status.status === 'error') {
                        complete = true;
                        document.getElementById('output').innerHTML = '<div class="error-msg">Error: ' + (status.error || 'Video generation failed') + '</div>';
                    }
                }
            } catch (err) {
                console.error('Video polling error:', err);
                document.getElementById('output').innerHTML = '<div class="error-msg">Error: ' + err.message + '</div>';
            }
        }
        
        function showResult(data) {
            const fileUrl = data.file_url ? API + data.file_url : null;
            const info = data.data || {};
            let html = '<div class="success-msg">‚úÖ Generated successfully!</div>';
            
            if (data.tool_name === 'ppt_video' && fileUrl) {
                // Video: Display from server file
                html += `
                    <div class="info">
                        <p><strong>üé¨ Video Ready!</strong></p>
                        <p><strong>‚è±Ô∏è Duration:</strong> ${info.duration_seconds || 60}s</p>
                        <p><strong>üìä Slides:</strong> ${info.total_slides || 6}</p>
                    </div>
                    <div class="video-box">
                        <video controls autoplay id="generatedVideo">
                            <source src="${fileUrl}" type="video/mp4">
                        </video>
                    </div>
                    <a href="${fileUrl}?download=true" download class="download-btn">üì• Download Video</a>
                `;
                
            } else if (data.tool_name === 'pdf' && info.pdf_base64) {
                // PDF: Display from base64 data (not saved on server)
                const pdfDataUrl = 'data:application/pdf;base64,' + info.pdf_base64;
                html += `
                    <div class="info">
                        <p><strong>üìÑ PDF Document</strong></p>
                        <p style="font-size:0.8rem;color:#64748b;">Generated in memory - not saved on server</p>
                    </div>
                    <iframe src="${pdfDataUrl}" class="pdf-frame"></iframe>
                    <div style="margin-top:1rem;">
                        <a href="${pdfDataUrl}" target="_blank" class="download-btn" style="background:#3b82f6;">üîó Open in New Tab</a>
                        <button onclick="downloadPdfBase64('${info.pdf_base64}')" class="download-btn">üì• Download PDF</button>
                    </div>
                `;
                
            } else if (data.tool_name === 'presentation' && info.slides) {
                html += '<div class="slides">';
                info.slides.forEach(s => {
                    if (s.image_base64) {
                        html += `<div class="slide"><img src="data:image/png;base64,${s.image_base64}"></div>`;
                    }
                });
                html += '</div>';
                
            } else if (data.tool_name === 'flashcards' && info.flashcards) {
                html += '<p style="margin-bottom:1rem;color:#64748b;">Click cards to flip</p><div class="cards">';
                info.flashcards.forEach((c, i) => {
                    html += `<div class="flashcard" onclick="this.classList.toggle('flipped')">
                        <div class="q">Q${i+1}: ${escapeHtml(c.question)}</div>
                        <div class="answer">A: ${escapeHtml(c.answer)}</div>
                    </div>`;
                });
                html += '</div>';
                
            } else if (data.tool_name === 'mind_map' && info.mind_map) {
                // Render interactive mind map
                html += `
                    <div class="mind-map-info">
                        <span>üìä <strong>${info.total_nodes || 0}</strong> nodes</span>
                        <span>üìè <strong>${info.max_depth || 0}</strong> levels deep</span>
                        <button onclick="expandAll()" style="float:right;padding:0.25rem 0.5rem;background:#334155;border:none;color:#e2e8f0;border-radius:4px;cursor:pointer;margin-left:0.5rem;">Expand All</button>
                        <button onclick="collapseAll()" style="float:right;padding:0.25rem 0.5rem;background:#334155;border:none;color:#e2e8f0;border-radius:4px;cursor:pointer;">Collapse All</button>
                    </div>
                    <div class="mind-map-container" id="mindMapContainer">
                        ${renderMindMapNode(info.mind_map, 0)}
                    </div>
                `;
                
            } else {
                html += '<pre style="background:#0f172a;padding:1rem;border-radius:8px;overflow:auto;">' + JSON.stringify(info, null, 2) + '</pre>';
            }
            
            document.getElementById('output').innerHTML = html;
        }
        
        function renderMindMapNode(node, level) {
            if (!node) return '';
            
            const hasChildren = node.children && node.children.length > 0;
            const isExpanded = level < 2; // Auto-expand first 2 levels
            
            let html = `<div class="mm-node ${isExpanded ? 'expanded' : ''}" data-level="${level}">`;
            html += `<div class="mm-node-header" onclick="toggleNode(this.parentElement)">`;
            html += `<span class="mm-toggle">${hasChildren ? (isExpanded ? '‚ñº' : '‚ñ∂') : '‚Ä¢'}</span>`;
            html += `<div>`;
            html += `<div class="mm-label">${escapeHtml(node.label || node.text || '')}</div>`;
            if (node.description) {
                html += `<div class="mm-desc">${escapeHtml(node.description)}</div>`;
            }
            html += `</div></div>`;
            
            if (hasChildren) {
                html += `<div class="mm-children">`;
                node.children.forEach(child => {
                    html += renderMindMapNode(child, level + 1);
                });
                html += `</div>`;
            }
            
            html += `</div>`;
            return html;
        }
        
        function toggleNode(node) {
            node.classList.toggle('expanded');
            const toggle = node.querySelector('.mm-toggle');
            if (toggle && node.querySelector('.mm-children')) {
                toggle.textContent = node.classList.contains('expanded') ? '‚ñº' : '‚ñ∂';
            }
        }
        
        function expandAll() {
            document.querySelectorAll('.mm-node').forEach(n => {
                n.classList.add('expanded');
                const toggle = n.querySelector('.mm-toggle');
                if (toggle && n.querySelector('.mm-children')) toggle.textContent = '‚ñº';
            });
        }
        
        function collapseAll() {
            document.querySelectorAll('.mm-node').forEach(n => {
                if (n.dataset.level !== '0') {
                    n.classList.remove('expanded');
                    const toggle = n.querySelector('.mm-toggle');
                    if (toggle && n.querySelector('.mm-children')) toggle.textContent = '‚ñ∂';
                }
            });
        }
        
        function downloadFile(url, name) {
            const a = document.createElement('a');
            a.href = url;
            a.download = name;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }
        
        function downloadPdfBase64(base64Data) {
            // Convert base64 to blob and download
            const byteCharacters = atob(base64Data);
            const byteNumbers = new Array(byteCharacters.length);
            for (let i = 0; i < byteCharacters.length; i++) {
                byteNumbers[i] = byteCharacters.charCodeAt(i);
            }
            const byteArray = new Uint8Array(byteNumbers);
            const blob = new Blob([byteArray], { type: 'application/pdf' });
            
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'document.pdf';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        function downloadVideoBase64(base64Data) {
            // Convert base64 to blob and download
            const byteCharacters = atob(base64Data);
            const byteNumbers = new Array(byteCharacters.length);
            for (let i = 0; i < byteCharacters.length; i++) {
                byteNumbers[i] = byteCharacters.charCodeAt(i);
            }
            const byteArray = new Uint8Array(byteNumbers);
            const blob = new Blob([byteArray], { type: 'video/mp4' });
            
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'video.mp4';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        function escapeHtml(s) {
            return s ? String(s).replace(/</g, '&lt;').replace(/>/g, '&gt;') : '';
        }
        
        // Check server on load
        fetch(API + '/health').then(r => {
            if (r.ok) console.log('Server connected');
        }).catch(() => {
            alert('Server not running! Start the backend first.');
        });
    </script>
</body>
</html>
